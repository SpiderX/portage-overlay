From c2c2f4f5a8c9df156fd7212773fbbea27fb93738 Mon Sep 17 00:00:00 2001
From: David Beazley <dave@dabeaz.com>
Date: Tue, 9 Apr 2024 18:47:02 -0500
Subject: [PATCH] Removed skipped/flaky tests

---
 tests/test_channel.py | 30 ------------------------------
 tests/test_io.py      | 42 ------------------------------------------
 tests/test_socket.py  |  7 -------
 tests/test_thread.py  | 17 -----------------
 4 files changed, 96 deletions(-)

diff --git a/tests/test_channel.py b/tests/test_channel.py
index 2247b4a1..cb3cbe3d 100644
--- a/tests/test_channel.py
+++ b/tests/test_channel.py
@@ -396,36 +396,6 @@ async def main(ch1, ch2):
 
     kernel.run(main(*chs))
 
-@pytest.mark.skip
-def test_channel_slow_connect(kernel, chs):
-    results = []
-
-    async def server(ch):
-        await sleep(2)
-        c = await ch.accept(authkey=b'peekaboo')
-        async with c:
-            await c.send('server hello world')
-            results.append(await c.recv())
-
-    async def client(ch):
-        c = await ch.connect(authkey=b'peekaboo')
-        async with c:
-            msg = await c.recv()
-            results.append(msg)
-            await c.send('client hello world')
-
-    async def main(ch1, ch2):
-        async with ch1, ch2:
-            t1 = await spawn(server, ch1)
-            t2 = await spawn(client, ch2)
-            await t1.join()
-            await t2.join()
-
-    kernel.run(main(*chs))
-    assert results == ['server hello world',
-                       'client hello world']
-
-
 def test_recv_bytes_into(kernel, chs):
     import array
     results = { }
diff --git a/tests/test_io.py b/tests/test_io.py
index 70d28fbb..32ebefd3 100644
--- a/tests/test_io.py
+++ b/tests/test_io.py
@@ -796,48 +796,6 @@ async def main():
         'handler done'
         ]
 
-@pytest.mark.skipif(True,
-                    reason="flaky")
-def test_sendall_cancel(kernel, portno):
-    done = Event()
-    start = Event()
-    results = {}
-
-    async def handler(client, addr):
-        await start.wait()
-        nrecv = 0
-        while True:
-            data = await client.recv(1000000)
-            if not data:
-                break
-            nrecv += len(data)
-        results['handler'] = nrecv
-        await client.close()
-        await done.set()
-
-    async def test_client(address, serv):
-        sock = socket(AF_INET, SOCK_STREAM)
-        await sock.connect(address)
-        try:
-            await sock.sendall(b'x'*10000000)
-        except CancelledError as e:
-            results['sender'] = e.bytes_sent
-        await sock.close()
-
-    async def main():
-        serv = await spawn(tcp_server, '', portno, handler)
-        t = await spawn(test_client, ('localhost', portno), serv)
-        await sleep(0.1)
-        await t.cancel()
-        await start.set()
-        await serv.cancel()
-        await done.wait()
-
-    kernel.run(main())
-
-    assert results['handler'] == results['sender']
-
-
 def test_stream_bad_context(kernel, portno):
     done = Event()
     results = []
diff --git a/tests/test_socket.py b/tests/test_socket.py
index 8b17dc13..032d7698 100644
--- a/tests/test_socket.py
+++ b/tests/test_socket.py
@@ -596,13 +596,6 @@ async def main():
 
     kernel.run(main)
 
-def test_create_bad_connection(kernel):
-    async def main():
-        with pytest.raises(OSError):
-            await create_connection(('python.org', 1))
-
-    kernel.run(main)
-
 # Smoke test on various socket functions
 @pytest.mark.skipif(True,
                     reason='unreliable')
diff --git a/tests/test_thread.py b/tests/test_thread.py
index b324761b..e0773e3a 100644
--- a/tests/test_thread.py
+++ b/tests/test_thread.py
@@ -225,23 +225,6 @@ async def task():
 
     kernel.run(task)
 
-@pytest.mark.skip
-def test_thread_context(kernel):
-    results = []
-    async def func(x, y):
-        async with spawn_thread():
-            time.sleep(0.5)
-            results.append(AWAIT(simple_coro(x, y)))
-
-    async def main():
-        t = await spawn(func, 2, 3)
-        await sleep(0.1)
-        results.append(1)
-        await t.join()
-
-    kernel.run(main)
-    assert results == [1, 5]
-
 def test_await_passthrough(kernel):
     import time
     def add(x, y):
